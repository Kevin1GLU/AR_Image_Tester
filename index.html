<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR.js Video Display</title>
    <!-- Include the latest Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Include the latest AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Monospace;
        }
        #loadingMessage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.5);
            color: white;
            font-size: 24px;
            z-index: 999;
        }
        #debugInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
    </style>
</head>

<body>
    <div id="loadingMessage">Loading, please wait...</div>
    <div id="debugInfo">Debug: Initializing...</div>

    <video id="video" preload="auto" autoplay loop muted playsinline crossorigin="anonymous" style="display:none">
        <source src="blue_shockwave.mp4" type='video/mp4'>
    </video>
    
    <script>
        var scene, camera, renderer, clock, deltaTime, totalTime;
        var arToolkitSource, arToolkitContext;
        var markerRoot;
        var videoMesh;
        var videoElement, videoTexture;
        var debugElement = document.getElementById('debugInfo');
        var loadingElement = document.getElementById('loadingMessage');
        
        // Debug function that will display messages in the UI
        function debug(message) {
            console.log(message);
            debugElement.innerHTML = "Debug: " + message;
        }

        // Initialize the AR scene
        function initialize() {
            debug("Initializing Three.js scene");
            
            // Create scene and camera
            scene = new THREE.Scene();
            camera = new THREE.Camera();
            scene.add(camera);
            
            // Add ambient light
            let ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
            scene.add(ambientLight);
            
            // Set up renderer
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setClearColor(new THREE.Color('lightgrey'), 0);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0px';
            renderer.domElement.style.left = '0px';
            document.body.appendChild(renderer.domElement);
            
            // Set up clock for animation timing
            clock = new THREE.Clock();
            deltaTime = 0;
            totalTime = 0;
            
            // Initialize AR.js source (camera)
            debug("Setting up AR Toolkit Source");
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
            });
            
            // Handle resize events
            function onResize() {
                arToolkitSource.onResize();
                arToolkitSource.copySizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
                }
            }
            
            arToolkitSource.init(function onReady() {
                debug("AR Source Ready");
                onResize();
                setTimeout(() => {
                    onResize(); // Sometimes needed for mobile devices
                }, 1000);
            });
            
            window.addEventListener('resize', function() {
                onResize();
            });
            
            // Initialize AR context
            debug("Setting up AR Toolkit Context");
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'data/camera_para.dat',
                detectionMode: 'mono',
                maxDetectionRate: 60,
                canvasWidth: 640,
                canvasHeight: 480,
            });
            
            arToolkitContext.init(function onCompleted() {
                debug("AR Context Ready");
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });
            
            // Create marker root
            debug("Setting up marker");
            markerRoot = new THREE.Group();
            scene.add(markerRoot);
            
            let markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'pattern',
                patternUrl: 'markerr.patt',
                changeMatrixMode: 'cameraTransformMatrix'
            });
            
            // Set up video
            debug("Setting up video texture");
            videoElement = document.getElementById('video');
            
            // Add event listeners to debug video loading
            videoElement.addEventListener('loadeddata', function() {
                debug("Video loaded successfully");
            });
            
            videoElement.addEventListener('error', function() {
                debug("Error loading video: " + videoElement.error.code);
            });
            
            // Create video texture
            videoTexture = new THREE.VideoTexture(videoElement);
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;
            videoTexture.format = THREE.RGBFormat;
            
            // Create a plane with the video texture
            let geometry = new THREE.PlaneBufferGeometry(2, 2);
            let material = new THREE.MeshBasicMaterial({ 
                map: videoTexture,
                side: THREE.DoubleSide
            });
            
            videoMesh = new THREE.Mesh(geometry, material);
            videoMesh.rotation.x = -Math.PI/2; // Rotate to be parallel to the marker
            
            markerRoot.add(videoMesh);
            
            // Start video when marker is found
            markerRoot.addEventListener('markerFound', function() {
                debug("Marker found - playing video");
                videoElement.play().catch(e => debug("Video autoplay failed: " + e));
            });
            
            // Hide loading message when setup is complete
            loadingElement.style.display = 'none';
        }
        
        function update() {
            // Update AR toolkit
            if (arToolkitSource.ready !== false) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            
            // Check if marker is visible
            if (markerRoot.visible) {
                if (!videoElement.playing && videoElement.readyState === 4) {
                    videoElement.play().catch(e => console.error(e));
                }
            }
        }
        
        function render() {
            renderer.render(scene, camera);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            deltaTime = clock.getDelta();
            totalTime += deltaTime;
            update();
            render();
        }
        
        // Start everything after all resources are loaded
        window.addEventListener('DOMContentLoaded', function() {
            debug("Document loaded, waiting for AR resources");
            
            // We need to make sure AR.js is fully loaded before initializing
            const checkARReady = () => {
                if (typeof THREEx !== 'undefined' && 
                    THREEx.ArToolkitContext && 
                    THREEx.ArToolkitSource) {
                    debug("AR libraries loaded");
                    initialize();
                    animate();
                } else {
                    debug("Waiting for AR libraries...");
                    setTimeout(checkARReady, 100);
                }
            };
            
            checkARReady();
        });

        // Try playing video when user interacts with the page
        document.addEventListener('click', function() {
            if (videoElement) {
                videoElement.play().catch(e => console.error(e));
            }
        });
    </script>
</body>
</html>